# https://taskfile.dev
version: "3"

dotenv: [".env"]

vars:
  COMPOSE_FILE: infra/podman/compose.yaml

tasks:
  # ============================================
  # ä¸€æ‹¬å®Ÿè¡Œã‚¿ã‚¹ã‚¯
  # ============================================
  default:
    desc: ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
    cmds:
      - task --list

  setup:
    desc: åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« + ç’°å¢ƒæ§‹ç¯‰ï¼‰
    cmds:
      - task: check:deps
      - task: env:init
      - task: install
      - task: up
      - task: migrate:up
      - echo "âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼ http://localhost:3000 ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™"

  dev:
    desc: é–‹ç™ºç’°å¢ƒã‚’èµ·å‹•ï¼ˆPodman + ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
    deps: [up]
    cmds:
      - task: logs

  ci:
    desc: CIç”¨ã®å…¨ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œï¼ˆlint + security + test + buildï¼‰
    cmds:
      - task: check
      - task: security
      - task: test
      - task: build

  security:
    desc: å…¨ä½“ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    cmds:
      - task: frontend:security
      - task: backend:security

  check:
    desc: å…¨ä½“ã®ãƒã‚§ãƒƒã‚¯ï¼ˆlintï¼‰
    cmds:
      - task: frontend:lint
      - task: backend:lint

  test:
    desc: å…¨ä½“ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    cmds:
      - task: frontend:test
      - task: backend:test

  build:
    desc: å…¨ä½“ã®ãƒ“ãƒ«ãƒ‰
    cmds:
      - task: frontend:build
      - task: backend:build

  install:
    desc: å…¨ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    cmds:
      - task: frontend:install
      - task: backend:install

  # ============================================
  # ç’°å¢ƒãƒã‚§ãƒƒã‚¯
  # ============================================
  check:deps:
    desc: å¿…è¦ãªä¾å­˜ãƒ„ãƒ¼ãƒ«ã®ç¢ºèª
    cmds:
      - |
        echo "ğŸ” ä¾å­˜ãƒ„ãƒ¼ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

        # Node.js
        if ! command -v node &> /dev/null; then
          echo "âŒ Node.js ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
          exit 1
        fi
        echo "âœ… Node.js $(node -v)"

        # pnpm
        if ! command -v pnpm &> /dev/null; then
          echo "âŒ pnpm ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
          echo "   ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: npm install -g pnpm"
          exit 1
        fi
        echo "âœ… pnpm $(pnpm -v)"

        # Go
        if ! command -v go &> /dev/null; then
          echo "âŒ Go ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
          exit 1
        fi
        echo "âœ… Go $(go version | cut -d' ' -f3)"

        # Podman
        if ! command -v podman &> /dev/null; then
          echo "âŒ Podman ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
          exit 1
        fi
        echo "âœ… Podman $(podman -v | cut -d' ' -f3)"

        # podman compose
        if ! podman compose version &> /dev/null; then
          echo "âŒ podman compose ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“"
          echo "   Podman 4.1.0 ä»¥ä¸ŠãŒå¿…è¦ã§ã™"
          exit 1
        fi
        echo "âœ… podman compose $(podman compose version --short)"

        echo ""
        echo "ğŸ‰ å…¨ã¦ã®ä¾å­˜ãƒ„ãƒ¼ãƒ«ãŒæƒã£ã¦ã„ã¾ã™ï¼"
    silent: true

  env:init:
    desc: .env ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆæœŸåŒ–
    cmds:
      - |
        if [ ! -f .env ]; then
          cp .env.example .env
          echo "âœ… .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
        else
          echo "â„¹ï¸  .env ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"
        fi
    silent: true

  # ============================================
  # Podman
  # ============================================
  up:
    desc: å…¨ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•ï¼ˆPostgreSQL + Backend + Frontendï¼‰
    cmds:
      - podman compose -f {{.COMPOSE_FILE}} up -d
      - echo "âœ… ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ã—ã¾ã—ãŸ"
      - task: ps

  down:
    desc: å…¨ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
    cmds:
      - podman compose -f {{.COMPOSE_FILE}} down
      - echo "âœ… ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ã—ã¾ã—ãŸ"

  restart:
    desc: å…¨ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•
    cmds:
      - task: down
      - task: up

  logs:
    desc: ãƒ­ã‚°ã‚’ãƒ•ã‚©ãƒ­ãƒ¼
    cmds:
      - podman compose -f {{.COMPOSE_FILE}} logs -f

  logs:backend:
    desc: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ­ã‚°ã®ã¿è¡¨ç¤º
    cmds:
      - podman compose -f {{.COMPOSE_FILE}} logs -f backend

  logs:frontend:
    desc: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ­ã‚°ã®ã¿è¡¨ç¤º
    cmds:
      - podman compose -f {{.COMPOSE_FILE}} logs -f frontend

  ps:
    desc: ã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ…‹ç¢ºèª
    cmds:
      - podman compose -f {{.COMPOSE_FILE}} ps

  clean:
    desc: ã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒ»ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
    cmds:
      - podman compose -f {{.COMPOSE_FILE}} down -v
      - rm -rf frontend/.next frontend/node_modules
      - rm -rf backend/bin backend/tmp
      - echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

  # ============================================
  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
  # ============================================
  frontend:install:
    desc: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    dir: frontend
    cmds:
      - pnpm install

  frontend:dev:
    desc: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
    dir: frontend
    cmds:
      - pnpm dev

  frontend:build:
    desc: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰
    dir: frontend
    cmds:
      - pnpm build

  frontend:lint:
    desc: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®lintå®Ÿè¡Œ
    dir: frontend
    cmds:
      - pnpm lint:check

  frontend:lint:fix:
    desc: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®lintä¿®æ­£
    dir: frontend
    cmds:
      - pnpm lint

  frontend:test:
    desc: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
    dir: frontend
    cmds:
      - pnpm vitest run

  frontend:test:watch:
    desc: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆï¼ˆã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ï¼‰
    dir: frontend
    cmds:
      - pnpm test

  frontend:test:e2e:
    desc: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®E2Eãƒ†ã‚¹ãƒˆ
    dir: frontend
    cmds:
      - pnpm test:e2e

  frontend:security:
    desc: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    dir: frontend
    cmds:
      - echo "ğŸ” ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
      - pnpm audit --audit-level=high || true
      - echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"

  # ============================================
  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
  # ============================================
  backend:install:
    desc: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    dir: backend
    cmds:
      - go mod download

  backend:dev:
    desc: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆAir ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
    dir: backend
    cmds:
      - |
        if ! command -v air &> /dev/null; then
          echo "Air ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          go install github.com/air-verse/air@latest
        fi
        air

  backend:build:
    desc: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰
    dir: backend
    cmds:
      - go build -o bin/server ./cmd/server

  backend:lint:
    desc: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®lintå®Ÿè¡Œ
    dir: backend
    cmds:
      - go vet ./...
      - |
        if command -v staticcheck &> /dev/null; then
          staticcheck ./...
        else
          echo "âš ï¸  staticcheck ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰"
          echo "   ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: go install honnef.co/go/tools/cmd/staticcheck@latest"
        fi

  backend:test:
    desc: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    dir: backend
    cmds:
      - go test -v ./...

  backend:test:coverage:
    desc: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆï¼ˆã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãï¼‰
    dir: backend
    cmds:
      - go test -v -coverprofile=coverage.out ./...
      - go tool cover -html=coverage.out -o coverage.html
      - echo "âœ… coverage.html ã‚’ç”Ÿæˆã—ã¾ã—ãŸ"

  backend:security:
    desc: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    dir: backend
    env:
      PATH: "{{.HOME}}/go/bin:{{.PATH}}"
    cmds:
      - echo "ğŸ” Go ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ä¸­..."
      - |
        if ! command -v gosec &> /dev/null; then
          echo "gosec ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          go install github.com/securego/gosec/v2/cmd/gosec@latest
        fi
        ~/go/bin/gosec ./... || true
      - |
        if ! command -v govulncheck &> /dev/null; then
          echo "govulncheck ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          go install golang.org/x/vuln/cmd/govulncheck@latest
        fi
        ~/go/bin/govulncheck ./...
      - echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"

  # ============================================
  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
  # ============================================
  migrate:up:
    desc: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨
    dir: backend
    cmds:
      - |
        if ! command -v migrate &> /dev/null; then
          echo "golang-migrate ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest
        fi
        migrate -path migrations -database "${DATABASE_URL}" up

  migrate:down:
    desc: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆ1ã¤ï¼‰
    dir: backend
    cmds:
      - migrate -path migrations -database "${DATABASE_URL}" down 1

  migrate:down:all:
    desc: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å…¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    dir: backend
    cmds:
      - migrate -path migrations -database "${DATABASE_URL}" down -all

  migrate:create:
    desc: æ–°è¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆï¼ˆNAME=xxxï¼‰
    dir: backend
    cmds:
      - |
        if [ -z "{{.NAME}}" ]; then
          echo "âŒ NAME ã‚’æŒ‡å®šã—ã¦ãã ã•ã„"
          echo "   ä¾‹: task migrate:create NAME=create_posts"
          exit 1
        fi
        migrate create -ext sql -dir migrations -seq {{.NAME}}
        echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"

  migrate:status:
    desc: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ç¢ºèª
    dir: backend
    cmds:
      - migrate -path migrations -database "${DATABASE_URL}" version

  # ============================================
  # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  # ============================================
  db:shell:
    desc: PostgreSQL ã«æ¥ç¶š
    cmds:
      - podman exec -it gonexttemp-postgres psql -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-gonexttemp}

  db:reset:
    desc: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼‰
    cmds:
      - task: migrate:down:all
      - task: migrate:up
      - echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ"
